{
    "_producer_rules": [
        [ [ "git_repo", "collection" ], [["clone"]], { "tags": ["git_repo", "collection"] } ]
    ],

    "git_tool_entry":   [ "^", "byquery", "shell_tool,can_git" ],

    "patch_tool_entry": [ "^", "byquery", "shell_tool,can_patch" ],

    "git_url": [ "^^", "execute", [[
        [ "get_kernel" ],
        [ "byname", "shell" ],
        [ "run", [], {
            "shell_cmd_with_subs": "\"#{git_tool_path}#\" -C #{repo_path}# config --get remote.origin.url",
            "git_tool_path": [ "^^", "dig", "git_tool_entry.tool_path" ],
            "repo_path": [ "^^", "get", "repo_path" ],
            "capture_output": true
        } ]
    ]] ],

    "url_prefix": [ "^^", "execute", [[
        [ "get", "git_url" ],
        0,
        [ "func", "os.path.dirname" ]
    ]] ],

    "url": [ "^^", "substitute", "#{url_prefix}#/#{repo_name}#" ],
    "repo_name": [ "^^", "url_2_repo_name" ],
    "checkout_part": [ "^^", "case", [ [ "^^", "get", ["checkout", ""] ], ["", false, null, "None"], "" ],
                               { "default_value": [ "^^", "substitute", "_#{checkout}#" ] }
                     ],
    "patch_part": [ "^^", "case", [ [ "^^", "get", ["patch", ""] ], ["", false, null, "None"], "" ],
                               { "default_value": [ "^^", "substitute", "_#{patch}#" ] }
                     ],

    "repo_dir_name": [ "^^", "substitute", "#{repo_name}##{checkout_part}##{patch_part}#" ],
    "rel_clone_dir": [ "^^", "substitute", "cloned_#{repo_dir_name}#" ],

    "repo_path": [ "^^", "get_path", "" ],

    "container_entry":  [ "^", "work_collection" ],

    "current_checkout": [ "^^", "execute", [[
        [ "get_kernel" ],
        [ "byname", "shell" ],
        [ "run", [], {
            "shell_cmd_with_subs": "\"#{git_tool_path}#\" -C \"#{repo_path}#\" branch",
            "git_tool_path": [ "^^", "dig", "git_tool_entry.tool_path" ],
            "repo_path": [ "^^", "get", "repo_path" ],
            "capture_output": true
        } ],
        0,
        [ "func", ["ufun.rematch", "^\\*.*\\s(\\S+?)\\)?$"] ]
    ]] ],

    "checkout": [ "^^", "propose_checkout" ],

    "generated_entry_parents": [ "AS^IS", "AS^IS", [ "^", "byname", "git" ] ],
    "generated_entry_tags": [ "git_repo" ],
    "generated_entry_param_names": [ "repo_name", "checkout", "submodules", "abs_patch_path", "patch", "contained_files" ],
    "generated_entry": [ "^^", "execute", [[
        [ "get", "__record_entry__" ],
        [ "set_path", [ "^^", "get", "repo_dir_name" ] ],
        [ "attach", [ "^^", "get", "container_entry" ] ],
        [ "plant", [
            "_parent_entries", [ "^^", "get", "generated_entry_parents" ],
            "tags", [ "^^", "get", "generated_entry_tags" ],
            "repo_name", [ "^^", "get", "repo_name" ]
        ]],
        [ "plant", [ "^^", "slice", ["^^", "get", "generated_entry_param_names" ], { "plantable": true, "skip_missing": true } ] ],
        [ "save" ]
    ]] ]
}
